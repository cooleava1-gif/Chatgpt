<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>基金看板 v4（GitHub Pages）</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#8ea0c7; --text:#e9efff;
      --good:#36d399; --bad:#fb7185; --line:#22305a; --btn:#2b63ff; --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#070a14,#0b1020 35%,#070a14);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
    .wrap{max-width:1100px;margin:22px auto;padding:0 14px 40px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .title{font-size:18px;font-weight:800}
    .subtitle{color:var(--muted);font-size:12px;margin-top:4px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(18,26,51,.88);border:1px solid rgba(34,48,90,.9);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0;padding:14px 14px 0;font-size:14px;color:#cfe0ff}
    .inner{padding:12px 14px 14px}
    .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:720px){.metrics{grid-template-columns:repeat(2,1fr)}}
    .m{padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(10,14,30,.6)}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:18px;font-weight:900;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input,select,button{border-radius:12px;border:1px solid var(--line);background:rgba(10,14,30,.65);
      color:var(--text);padding:10px 10px;font-size:14px}
    button{cursor:pointer;border-color:rgba(43,99,255,.6);background:linear-gradient(180deg,rgba(43,99,255,.95),rgba(43,99,255,.65))}
    button.secondary{background:rgba(10,14,30,.65);border-color:var(--line)}
    button.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.6)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .tip{font-size:12px;color:var(--muted);line-height:1.55;margin-top:10px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;color:var(--muted);font-weight:700;text-align:left;padding:0 10px}
    tbody td{padding:12px 10px;border-top:1px solid rgba(34,48,90,.35);border-bottom:1px solid rgba(34,48,90,.35);font-size:13px}
    tbody tr{background:rgba(10,14,30,.55)}
    tbody tr td:first-child{border-left:1px solid rgba(34,48,90,.35);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tbody tr td:last-child{border-right:1px solid rgba(34,48,90,.35);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .good{color:var(--good);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .warn{color:var(--warn);font-weight:800}
    .muted{color:var(--muted)}
    .chartwrap{height:320px}
    canvas{width:100%;height:100%;display:block;background:rgba(10,14,30,.45);border:1px solid rgba(34,48,90,.6);border-radius:14px}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(10,14,30,.65);border:1px solid var(--line);
      border-radius:14px;padding:12px;color:#cfe0ff;font-size:12px;line-height:1.55;margin:0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="title">基金看板 v4（GitHub Pages）(｀・ω・´)</div>
      <div class="subtitle">v4 特点：按钮必能点；错误直接显示在页面；7日曲线从买入日/确认逻辑计算；LOF(161226) 自动识别深/沪市场。</div>
    </div>
    <div class="row">
      <div class="pill" id="status">JS：启动中…</div>
      <button class="secondary" id="btnRefresh">手动刷新</button>
      <select id="auto">
        <option value="60">自动刷新 60秒</option>
        <option value="120">自动刷新 2分钟</option>
        <option value="300">自动刷新 5分钟</option>
        <option value="0">关闭自动刷新</option>
      </select>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>总览</h3>
      <div class="inner">
        <div class="metrics">
          <div class="m"><div class="k">总投入</div><div class="v" id="mInvest">--</div></div>
          <div class="m"><div class="k">总市值</div><div class="v" id="mValue">--</div></div>
          <div class="m"><div class="k">浮动盈亏</div><div class="v" id="mProfit">--</div></div>
          <div class="m"><div class="k">浮动收益率</div><div class="v" id="mRoi">--</div></div>
        </div>
        <div class="tip">
          规则：确认日 = 净值序列里 ≥ 买入日 的第一个交易日；起息 = 确认日的下一交易日。起息日前收益按 0 计。<br/>
          tip：15:00 后买入可把“买入日”选成下一个交易日，更贴近确认/起息逻辑。
        </div>
      </div>
    </div>

    <div class="card">
      <h3>新增持仓</h3>
      <div class="inner">
        <div class="row">
          <label style="min-width:150px;">代码<input id="inCode" placeholder="例：161226 / 002207" /></label>
          <label style="min-width:220px;">类型
            <select id="inType">
              <option value="fund">基金（场外净值）</option>
              <option value="lof">LOF（净值买入 + 场内价卖出）</option>
              <option value="market">场内（ETF/股票：纯场内价）</option>
            </select>
          </label>
          <label style="min-width:170px;">买入日<input id="inBuyDate" type="date" /></label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label style="min-width:170px;">投入（元）<input id="inAmount" inputmode="decimal" placeholder="例：1000" /></label>
          <label style="min-width:220px;">成本口径
            <select id="inCostMode">
              <option value="auto">自动（确认日净值/买入日收盘）</option>
              <option value="manual">手动填成本单价</option>
            </select>
          </label>
          <label style="min-width:210px;">成本单价（可空）<input id="inCostPrice" inputmode="decimal" placeholder="不填则自动推算" /></label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnAdd">新增</button>
          <button class="secondary" id="btnClear">清空输入</button>
          <button class="secondary" id="btnWipe">清空持仓</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h3>持仓明细</h3>
    <div class="inner">
      <div class="muted" id="hint">--</div>
      <div style="overflow:auto;margin-top:8px;">
        <table>
          <thead>
          <tr>
            <th>名称/代码</th><th>类型</th><th>买入日</th><th>确认/起息</th><th>投入</th><th>成本单价</th><th>份额</th>
            <th>净值(日期)</th><th>场内价</th><th>溢价</th><th>市值</th><th>盈亏</th><th>收益率</th><th>操作</th>
          </tr>
          </thead>
          <tbody id="tb">
          <tr><td colspan="14" class="muted">暂无持仓。先新增一个 (ง •̀_•́)ง</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>7日曲线（从买入日/确认逻辑计算）</h3>
      <div class="inner">
        <div class="row" style="align-items:center;justify-content:space-between;">
          <label style="min-width:260px;">曲线对象
            <select id="curveSel"></select>
          </label>
          <div class="pill" id="curveState">曲线状态：--</div>
        </div>
        <div class="chartwrap"><canvas id="cv" width="1000" height="360"></canvas></div>
      </div>
    </div>
    <div class="card">
      <h3>调试信息（把这里复制给我就能秒定位）</h3>
      <div class="inner"><pre id="dbg">--</pre></div>
    </div>
  </div>
</div>

<script>
(() => {
  const VERSION = "v4_2026-02-02";
  const $ = (id) => document.getElementById(id);
  const logLines = [];
  const log = (msg, obj) => {
    const t = new Date().toLocaleString();
    logLines.push(`[${t}] ${msg}${obj ? " " + safe(obj) : ""}`);
    if (logLines.length > 200) logLines.shift();
    $("dbg").textContent = logLines.join("\\n");
  };
  const safe = (o) => { try{return JSON.stringify(o);}catch{return String(o);} };
  const todayStr = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };
  const fmtMoney = (n) => isFinite(n) ? Number(n).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}) : "--";
  const fmtPct = (n) => isFinite(n) ? (n*100).toFixed(2)+"%" : "--";
  const setStatus = (ok, text) => {
    const el = $("status");
    el.textContent = text;
    el.style.borderColor = ok ? "rgba(54,211,153,.6)" : "rgba(251,113,133,.6)";
    el.style.color = ok ? "#bfffe5" : "#ffd1d9";
  };

  // 报错直接显示在页面，不用你开控制台
  window.addEventListener("error", (e) => {
    setStatus(false, "JS：报错（看右下调试）");
    log("window.error", {message:e.message, file:e.filename, line:e.lineno, col:e.colno});
  });
  window.addEventListener("unhandledrejection", (e) => {
    setStatus(false, "JS：Promise报错（看右下调试）");
    log("unhandledrejection", {reason:String(e.reason)});
  });

  // JSONP：跨域稳
  function jsonp(url, cbParam="cb", timeoutMs=12000){
    return new Promise((resolve,reject)=>{
      const cbName="__jp_"+Math.random().toString(16).slice(2);
      const sep=url.includes("?")?"&":"?";
      const full=url+sep+cbParam+"="+cbName+"&_="+Date.now();
      let done=false;
      const timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);
      function cleanup(){ clearTimeout(timer); delete window[cbName]; script.remove(); }
      window[cbName]=(data)=>{ if(done) return; done=true; cleanup(); resolve(data); };
      const script=document.createElement("script");
      script.src=full;
      script.onerror=()=>{ if(done) return; done=true; cleanup(); reject(new Error("JSONP load error")); };
      document.head.appendChild(script);
    });
  }

  // 净值：pingzhongdata（基金/LOF通用）
  function msToDate(ms){
    const d=new Date(ms); const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function loadNav(code){
    return new Promise((resolve,reject)=>{
      const url=`https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
      const s=document.createElement("script");
      s.src=url;
      s.onload=()=>{
        try{
          const name=window.fS_name;
          const trend=window.Data_netWorthTrend;
          if(!name || !Array.isArray(trend) || !trend.length) throw new Error("nav missing fields");
          const navSeries=trend.map(it=>({date:msToDate(it.x), nav:Number(it.y)}))
            .filter(x=>x.date && isFinite(x.nav)).sort((a,b)=>a.date.localeCompare(b.date));
          const latest=navSeries[navSeries.length-1];
          // 清理全局污染
          ["fS_name","fS_code","Data_netWorthTrend","Data_ACWorthTrend","Data_grandTotal"].forEach(k=>{try{delete window[k];}catch{}});
          s.remove();
          resolve({name, navSeries, latestNav:latest?.nav, latestNavDate:latest?.date});
        }catch(e){ s.remove(); reject(e); }
      };
      s.onerror=()=>{ s.remove(); reject(new Error("pingzhongdata load error")); };
      document.head.appendChild(s);
    });
  }

  // 行情：push2（自动尝试深/沪）
  function guessSecId(code){
    if(/^16/.test(code)) return "0."+code;        // 161226 这类 LOF 多在深市
    if(/^(5|6|9)/.test(code)) return "1."+code;   // 沪市常见
    return "0."+code;
  }
  async function loadQuote(code){
    const a=guessSecId(code);
    const list = a.startsWith("0.") ? [a, "1."+code] : [a, "0."+code];
    let lastErr=null;
    for(const secid of list){
      try{
        const url=`https://push2.eastmoney.com/api/qt/stock/get?secid=${secid}&fields=f2,f12,f14`;
        const data=await jsonp(url,"cb",10000);
        const d=data?.data;
        const price=Number(d?.f2);
        const name=d?.f14;
        if(name && isFinite(price) && price>0) return {secid, name, price};
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error("quote failed");
  }

  // K线：用来做7日曲线（场内/LOF的场内价）
  async function loadKlineClose(code, limit=30){
    const a=guessSecId(code);
    const list = a.startsWith("0.") ? [a, "1."+code] : [a, "0."+code];
    let lastErr=null;
    for(const secid of list){
      try{
        const url=`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secid}&klt=101&fqt=1&lmt=${limit}&fields2=f51,f52,f53,f54,f55,f56`;
        const data=await jsonp(url,"cb",12000);
        const kl=data?.data?.klines;
        if(Array.isArray(kl) && kl.length){
          const rows=kl.map(s=>{
            const [date,open,close]=s.split(",");
            return {date, close:Number(close)};
          }).filter(x=>x.date && isFinite(x.close));
          if(rows.length) return {secid, rows};
        }
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error("kline failed");
  }

  // 确认/起息
  function calcConfirmInterest(navSeries, buyDate){
    const idx = navSeries.findIndex(x=>x.date >= buyDate);
    if(idx === -1){
      const last=navSeries[navSeries.length-1];
      return {confirmDate:last.date, interestDate:last.date};
    }
    const confirm=navSeries[idx].date;
    const interest=navSeries[idx+1]?.date || confirm;
    return {confirmDate:confirm, interestDate:interest};
  }

  // 存储
  const LS="fund_holdings_v4";
  const cache = { nav:new Map(), quote:new Map(), kline:new Map() };
  let holdings=[];
  function save(){ localStorage.setItem(LS, JSON.stringify(holdings)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LS)||"[]")||[]; }catch{return [];} }
  function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }

  function typeLabel(t){
    if(t==="fund") return "基金";
    if(t==="lof") return "LOF";
    return "场内";
  }

  // 计算单笔
  async function computeOne(h){
    const code=h.code;
    const invest=Number(h.amount);
    const buyDate=h.buyDate;
    const costMode=h.costMode;
    let costPrice=Number(h.costPrice);

    let navData=null, quote=null, kline=null;
    if(h.type==="fund" || h.type==="lof"){
      navData = cache.nav.get(code) || await loadNav(code);
      cache.nav.set(code, navData);
    }
    if(h.type==="lof" || h.type==="market"){
      quote = cache.quote.get(code) || await loadQuote(code);
      cache.quote.set(code, quote);
      kline = cache.kline.get(code) || await loadKlineClose(code, 40);
      cache.kline.set(code, kline);
    }

    let confirmDate="--", interestDate="--";
    let shares=NaN;

    if(h.type==="market"){
      if(!isFinite(costPrice) || costPrice<=0){
        const row = kline?.rows?.find(r=>r.date===buyDate) || kline?.rows?.[kline.rows.length-1];
        costPrice = (costMode==="manual" && isFinite(costPrice)) ? costPrice : Number(row?.close) || Number(quote?.price);
      }
      shares = invest / costPrice;
    }else{
      const navSeries=navData.navSeries;
      const ci=calcConfirmInterest(navSeries, buyDate);
      confirmDate=ci.confirmDate; interestDate=ci.interestDate;

      if(!isFinite(costPrice) || costPrice<=0){
        const navOnConfirm = navSeries.find(x=>x.date===confirmDate)?.nav;
        costPrice = (costMode==="manual" && isFinite(costPrice)) ? costPrice : Number(navOnConfirm) || Number(navData.latestNav);
      }
      shares = invest / costPrice;
    }

    const nav=navData?.latestNav;
    const navDate=navData?.latestNavDate;
    const mkt=quote?.price;

    let value=NaN, profit=NaN;
    const t=todayStr();

    if(h.type==="fund"){
      if(t < interestDate){ value=invest; profit=0; }
      else { value=shares*Number(nav); profit=value-invest; }
    }else if(h.type==="lof"){
      // LOF：成本按净值，价值按场内价（你最终按场内卖）
      if(t < interestDate){ value=invest; profit=0; }
      else { value=shares*Number(mkt); profit=value-invest; }
    }else{
      value=shares*Number(mkt);
      profit=value-invest;
    }

    let premium=NaN;
    if(h.type==="lof" && isFinite(nav) && nav>0 && isFinite(mkt) && mkt>0){
      premium = mkt/nav - 1;
    }

    return {
      id:h.id, code, name: quote?.name || navData?.name || "--", type:h.type,
      buyDate, confirmDate, interestDate,
      invest, costPrice, shares,
      nav, navDate, mkt, premium,
      value, profit, roi: profit/invest
    };
  }

  // 曲线：从买入日开始取后续“可用交易日”7个点；起息日前点显示 0
  async function buildCurve(targetId){
    const points=[];
    const title = targetId==="ALL" ? "总组合" : (holdings.find(x=>x.id===targetId)?.code || "--");

    if(targetId==="ALL"){
      // 组合：取所有持仓各自 series 的日期并加总（近7点）
      const arr = await Promise.allSettled(holdings.map(h => buildCurve(h.id)));
      const ok = arr.filter(x=>x.status==="fulfilled").map(x=>x.value);
      const dateSet=new Set();
      ok.forEach(o=>o.points.forEach(p=>dateSet.add(p.date)));
      const dates=[...dateSet].sort().slice(-7);
      for(const d of dates){
        let investSum=0, profitSum=0;
        for(const o of ok){
          const p=o.points.find(x=>x.date===d);
          if(!p) continue;
          investSum += o.invest;
          profitSum += p.profit;
        }
        if(investSum>0) points.push({date:d, profit:profitSum, roi:profitSum/investSum});
      }
      return { title, points, invest: ok.reduce((s,o)=>s+o.invest,0) };
    }

    const h=holdings.find(x=>x.id===targetId);
    if(!h) return { title, points, invest:0 };

    // 先算出确认/起息、份额
    const one = await computeOne(h);
    const invest=one.invest;

    if(h.type==="market"){
      const kline = cache.kline.get(h.code) || await loadKlineClose(h.code, 60);
      cache.kline.set(h.code, kline);
      // 从买入日往后找点（取7个）
      const rows = kline.rows.filter(r=>r.date >= h.buyDate).slice(0, 7);
      for(const r of rows){
        const value = one.shares * r.close;
        const profit = value - invest;
        points.push({date:r.date, profit, roi:profit/invest});
      }
      return { title:`${one.name}（${one.code}）`, points, invest };
    }

    if(h.type==="fund"){
      const navData = cache.nav.get(h.code) || await loadNav(h.code);
      cache.nav.set(h.code, navData);
      const series = navData.navSeries.filter(x=>x.date >= h.buyDate).slice(0, 7);
      for(const r of series){
        if(r.date < one.interestDate) points.push({date:r.date, profit:0, roi:0});
        else{
          const value = one.shares * r.nav;
          const profit = value - invest;
          points.push({date:r.date, profit, roi:profit/invest});
        }
      }
      return { title:`${one.name}（${one.code}）`, points, invest };
    }

    // LOF：用场内K线做曲线，但起息前为0
    const kline = cache.kline.get(h.code) || await loadKlineClose(h.code, 60);
    cache.kline.set(h.code, kline);
    const rows = kline.rows.filter(r=>r.date >= h.buyDate).slice(0, 7);
    for(const r of rows){
      if(r.date < one.interestDate) points.push({date:r.date, profit:0, roi:0});
      else{
        const value = one.shares * r.close;
        const profit = value - invest;
        points.push({date:r.date, profit, roi:profit/invest});
      }
    }
    return { title:`${one.name}（${one.code}）`, points, invest };
  }

  // 简易画图（不依赖 Chart.js）
  function draw(points){
    const cv=$("cv");
    const ctx=cv.getContext("2d");
    const w=cv.width, h=cv.height;
    ctx.clearRect(0,0,w,h);

    // 网格
    ctx.globalAlpha=0.25;
    ctx.strokeStyle="#8ea0c7";
    ctx.lineWidth=1;
    for(let i=1;i<=4;i++){
      const y = (h*i)/5;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    }
    ctx.globalAlpha=1;

    if(!points.length){
      ctx.fillStyle="#8ea0c7";
      ctx.font="16px system-ui";
      ctx.fillText("暂无曲线数据", 20, 40);
      return;
    }

    const xs = points.map((p,i)=>i);
    const profits = points.map(p=>p.profit);
    const rois = points.map(p=>p.roi);

    const minP=Math.min(...profits), maxP=Math.max(...profits);
    const minR=Math.min(...rois), maxR=Math.max(...rois);

    const pad=30;
    const xMap = (i)=> pad + (w-2*pad) * (i/(points.length-1 || 1));
    const yMapP = (v)=> pad + (h-2*pad) * (1 - (v - minP) / ((maxP-minP) || 1));
    const yMapR = (v)=> pad + (h-2*pad) * (1 - (v - minR) / ((maxR-minR) || 1));

    // profit 线
    ctx.strokeStyle="#36d399";
    ctx.lineWidth=3;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x=xMap(i), y=yMapP(p.profit);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // roi 线
    ctx.strokeStyle="#fbbf24";
    ctx.lineWidth=2;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x=xMap(i), y=yMapR(p.roi);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // 标注日期（底部）
    ctx.fillStyle="#8ea0c7";
    ctx.font="12px system-ui";
    points.forEach((p,i)=>{
      const x=xMap(i);
      ctx.fillText(p.date.slice(5), x-14, h-10);
    });

    // 标题
    ctx.fillStyle="#cfe0ff";
    ctx.font="14px system-ui";
    ctx.fillText("绿线=盈亏额  黄线=收益率", 20, 22);
  }

  function renderTable(rows){
    const tb=$("tb");
    tb.innerHTML="";
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="14" class="muted">暂无持仓。先新增一个 (ง •̀_•́)ง</td></tr>`;
      return;
    }
    rows.forEach(r=>{
      const pCls = r.profit>=0 ? "good":"bad";
      const rCls = r.roi>=0 ? "good":"bad";
      const premTxt = isFinite(r.premium) ? fmtPct(r.premium) : "--";
      const premCls = isFinite(r.premium) ? (r.premium>=0 ? "warn":"muted") : "muted";
      const navTxt = isFinite(r.nav) ? (r.nav.toFixed(4) + " (" + r.navDate + ")") : "--";
      const mktTxt = isFinite(r.mkt) ? r.mkt.toFixed(4) : "--";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><div style="font-weight:900">${escapeHtml(r.name)}</div><div class="muted">${r.code}</div></td>
        <td class="muted">${typeLabel(r.type)}</td>
        <td class="muted">${r.buyDate}</td>
        <td class="muted">${r.confirmDate}/${r.interestDate}</td>
        <td>${fmtMoney(r.invest)}</td>
        <td class="muted">${isFinite(r.costPrice)?r.costPrice.toFixed(4):"--"}</td>
        <td class="muted">${isFinite(r.shares)?r.shares.toFixed(4):"--"}</td>
        <td class="muted">${navTxt}</td>
        <td class="muted">${mktTxt}</td>
        <td class="${premCls}">${premTxt}</td>
        <td>${fmtMoney(r.value)}</td>
        <td class="${pCls}">${fmtMoney(r.profit)}</td>
        <td class="${rCls}">${fmtPct(r.roi)}</td>
        <td>
          <button class="secondary" data-act="curve" data-id="${r.id}">曲线</button>
          <button class="danger" data-act="del" data-id="${r.id}">删</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function populateCurveSel(){
    const sel=$("curveSel");
    sel.innerHTML="";
    const a=document.createElement("option");
    a.value="ALL"; a.textContent="总组合";
    sel.appendChild(a);
    holdings.forEach(h=>{
      const o=document.createElement("option");
      o.value=h.id;
      o.textContent=`${h.code} · ${typeLabel(h.type)}`;
      sel.appendChild(o);
    });
  }

  function renderMetrics(sumInvest,sumValue,sumProfit){
    $("mInvest").textContent=fmtMoney(sumInvest);
    $("mValue").textContent=fmtMoney(sumValue);
    const p=$("mProfit"); p.textContent=fmtMoney(sumProfit); p.className="v "+(sumProfit>=0?"good":"bad");
    const roi=sumProfit/sumInvest;
    const r=$("mRoi"); r.textContent=fmtPct(roi); r.className="v "+(roi>=0?"good":"bad");
  }

  let timer=null;

  async function refreshAll(){
    setStatus(true, `JS：刷新中… ${VERSION}`);
    log("refresh start", {version:VERSION, holdings:holdings.length});

    if(!holdings.length){
      $("hint").textContent="持仓数：0";
      renderMetrics(0,0,0);
      renderTable([]);
      populateCurveSel();
      $("curveState").textContent="曲线状态：无数据";
      draw([]);
      setStatus(true, `JS：就绪（无持仓）${VERSION}`);
      return;
    }

    const rows=[];
    for(const h of holdings){
      try{
        const r=await computeOne(h);
        rows.push(r);
      }catch(e){
        log("computeOne failed", {code:h.code, type:h.type, err:String(e)});
      }
    }

    let sumInvest=0,sumValue=0,sumProfit=0;
    rows.forEach(r=>{ sumInvest+=r.invest; sumValue+=r.value; sumProfit+=r.profit; });
    renderMetrics(sumInvest,sumValue,sumProfit);
    renderTable(rows);
    $("hint").textContent=`持仓数：${rows.length}（失败项看调试信息）`;

    populateCurveSel();
    const target=$("curveSel").value || "ALL";
    try{
      const curve=await buildCurve(target);
      $("curveState").textContent = curve.points.length ? `曲线状态：${curve.title}（${curve.points.length}点）` : `曲线状态：无数据`;
      draw(curve.points);
    }catch(e){
      log("buildCurve failed", {target, err:String(e)});
      $("curveState").textContent="曲线状态：生成失败（看调试信息）";
      draw([]);
    }

    setStatus(true, `JS：就绪 ✅ ${VERSION}`);
    log("refresh done", {sumInvest,sumValue,sumProfit});
  }

  function bind(){
    $("btnRefresh").addEventListener("click", refreshAll);

    $("auto").addEventListener("change", ()=>{
      const s=Number($("auto").value);
      if(timer) clearInterval(timer);
      timer=null;
      if(s>0) timer=setInterval(refreshAll, s*1000);
      log("auto refresh", {seconds:s});
    });

    $("btnClear").addEventListener("click", ()=>{
      $("inCode").value="";
      $("inAmount").value="";
      $("inCostPrice").value="";
      $("inType").value="fund";
      $("inCostMode").value="auto";
      $("inBuyDate").value=todayStr();
    });

    $("btnWipe").addEventListener("click", ()=>{
      if(!confirm("确定清空全部持仓？")) return;
      holdings=[];
      save();
      refreshAll();
    });

    $("btnAdd").addEventListener("click", async ()=>{
      const code=$("inCode").value.trim();
      const type=$("inType").value;
      const buyDate=$("inBuyDate").value || todayStr();
      const amount=Number($("inAmount").value);
      const costMode=$("inCostMode").value;
      const costPrice=$("inCostPrice").value.trim();

      if(!/^[0-9]{6}$/.test(code)){ alert("代码请输入6位数字"); return; }
      if(!(amount>0)){ alert("投入金额必须 > 0"); return; }

      // 兜底：16开头默认当 LOF，更符合你要的 161226 逻辑
      const finalType = (type==="fund" && code.startsWith("16")) ? "lof" : type;

      const h={id:uid(), code, type:finalType, buyDate, amount, costMode, costPrice};
      holdings.push(h);
      save();
      log("add", h);

      // 立刻刷新，用于验证 161226
      await refreshAll();
    });

    $("curveSel").addEventListener("change", refreshAll);

    $("tb").addEventListener("click", (ev)=>{
      const btn=ev.target.closest("button");
      if(!btn) return;
      const act=btn.dataset.act;
      const id=btn.dataset.id;

      if(act==="del"){
        if(!confirm("确定删除？")) return;
        holdings = holdings.filter(x=>x.id!==id);
        save();
        refreshAll();
      }
      if(act==="curve"){
        $("curveSel").value=id;
        refreshAll();
      }
    });
  }

  function boot(){
    $("inBuyDate").value=todayStr();
    holdings=load();
    bind();
    $("auto").value="60";
    $("auto").dispatchEvent(new Event("change"));
    setStatus(true, `JS：启动完成 ${VERSION}`);
    log("boot", {version:VERSION});
    refreshAll();
  }

  document.addEventListener("DOMContentLoaded", boot);
})();
</script>
</body>
</html>
